{% extends 'base.html' %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing & Visualizing Data...</div>
</div>

<div style="margin-top: 1rem;">

    <!-- SECTION 1: HEADER -->

    <div class="dashboard-section">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <!-- PRINT HEADER (Hidden on Screen) -->
                <div class="print-only" style="margin-bottom: 2rem;">
                    <h1 style="color: black !important; font-size: 2.5rem; margin-bottom: 0.5rem;">Data Analysis Report
                    </h1>
                    <p style="color: #666 !important; font-size: 1rem;">File: <b>{{ filename }}</b> • Generated by
                        Moksha's AI • <span id="print-date"></span></p>
                    <hr style="border-color: #000; margin: 1rem 0;">
                </div>

                <!-- SCREEN HEADER -->
                <h2 style="font-size: 2rem; margin-bottom: 0.5rem; letter-spacing: -0.02em;">Analytics Dashboard</h2>
                <p style="color: var(--text-secondary);">Overview & Key Performance Indicators</p>
            </div>

            <div style="text-align: right; color: var(--text-tertiary); font-size: 0.85rem;">
                <!-- EXPORT BUTTON (Hidden on Print) -->
                <div class="no-print" style="margin-bottom: 0.5rem;">
                    <button class="btn btn-primary" onclick="window.print()" style="gap: 0.5rem;">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download Full Report (PDF)
                    </button>
                </div>
                <div>Enterprise Mode Active</div>
            </div>
        </div>
        <hr style="border: 0; border-bottom: 1px solid var(--border); margin-top: 1.5rem;">
    </div>

    <script>
        // Set date for print header
        document.addEventListener('DOMContentLoaded', () => {
            const d = new Date();
            const el = document.getElementById('print-date');
            if (el) el.textContent = d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
        });
    </script>

    <!-- SECTION 2: DATA INPUT -->
    <div class="dashboard-section">
        <div class="card" style="border-left: 4px solid var(--accent);">
            <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                <h3>Upload Dataset</h3>
            </div>
            <div style="padding-top: 1rem;">
                <form method="POST" enctype="multipart/form-data"
                    onsubmit="document.getElementById('loading-overlay').style.display = 'flex';">
                    <div style="display: flex; gap: 2rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 2; min-width: 300px;">
                            <label>Select CSV File</label>
                            <input type="file" name="file" accept=".csv" required class="form-control"
                                style="height: auto;">
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <label>Analysis Mode</label>
                            <div class="toggle-container"
                                style="background: var(--bg-card-alt); padding: 0.6rem; border-radius: var(--radius-sm); border: 1px solid var(--border);">
                                <label
                                    style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                                    <input type="radio" name="mode" value="business" checked>
                                    <span style="color: var(--text-primary);">Business</span>
                                </label>
                                <span style="color: var(--border);">|</span>
                                <label
                                    style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                                    <input type="radio" name="mode" value="exam">
                                    <span style="color: var(--text-primary);">Exam Mode</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="submit" class="btn btn-success" style="padding: 0.75rem 2rem;">
                            <svg class="icon" style="margin-right: 0.5rem;" viewBox="0 0 24 24">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            Analyze Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if has_data and chart_data %}
    <!-- SECTION 3: KPI SUMMARY -->
    <div class="dashboard-section">
        <div class="kpi-grid" id="kpi-section">
            <!-- Rendered via JS -->
        </div>
    </div>

    <!-- SECTION 4: VISUAL ANALYTICS -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Visual Analytics
            </div>
            <div class="section-subtitle">Key Trends & Patterns</div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Trend Analysis</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Metric Over Time</span>
                </div>
                <div class="chart-canvas-container"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Category Comparison</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Ranked Segments</span>
                </div>
                <div class="chart-canvas-container"><canvas id="barChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Correlation Matrix</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Variable Relationships</span>
                </div>
                <div class="chart-canvas-container"><canvas id="heatmapChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Anomaly Detection</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Outlier Highlights (Red)</span>
                </div>
                <div class="chart-canvas-container"><canvas id="scatterChart"></canvas></div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not has_data %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 4rem; color: var(--text-tertiary);">
        <svg class="icon" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p>No data analyzed yet. Please upload a CSV file.</p>
    </div>
    {% endif %}

</div>

{# Removed AI Insights from PDF report as per user request #}
{% if has_data %}
<div class="print-only dashboard-section" style="margin-top: 2rem; color: #666; font-style: italic;">
    [AI Insights are excluded from this PDF report.]
</div>
{% endif %}

<!-- 2. DATA SNAPSHOT -->
{% if preview_html %}
<div class="print-only dashboard-section" style="margin-top: 2rem; break-inside: avoid;">
    <h2
        style="font-size: 1.5rem; color: black; border-bottom: 2px solid #000; padding-bottom: 0.5rem; margin-bottom: 1rem;">
        Data Snapshot (First 10 Rows)
    </h2>
    <div style="font-size: 0.8rem; overflow: hidden;">
        {{ preview_html|safe }}
    </div>
</div>
{% endif %}

<!-- Scripts for Charts -->
{% if chart_data %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
<script>
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');

    // 1. Render KPIs
    const kpiContainer = document.getElementById('kpi-section');
    if (chartData && chartData.kpi) {
        const kpis = [
            { label: 'Total Rows', value: chartData.kpi.rows, sub: 'Dataset Size' },
            { label: 'Total Columns', value: chartData.kpi.columns, sub: 'Attributes' },
            { label: 'Missing Values', value: chartData.kpi.missing_count, sub: `${chartData.kpi.missing_pct}% Detected` },
            { label: 'Anomalies', value: chartData.kpi.anomaly_count, sub: `${chartData.kpi.anomaly_pct}% Outliers` }
        ];

        kpis.forEach(kpi => {
            const card = document.createElement('div');
            card.className = 'kpi-card';
            card.innerHTML = `
                <div class="kpi-value">${kpi.value.toLocaleString()}</div>
                <div class="kpi-label">${kpi.label}</div>
                <div class="kpi-subtext">${kpi.sub}</div>
            `;
            kpiContainer.appendChild(card);
        });
    }

    // Chart Configuration using Chart.js
    if (window.Chart) {
        const style = getComputedStyle(document.documentElement);
        const chartTextColor = style.getPropertyValue('--chart-text').trim() || '#94a3b8';
        const chartGridColor = style.getPropertyValue('--chart-grid').trim() || '#334155';
        const textPrimary = style.getPropertyValue('--text-primary').trim() || '#ffffff';

        Chart.defaults.color = chartTextColor;
        Chart.defaults.borderColor = chartGridColor;
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: textPrimary, font: { family: 'Inter' } }
                }
            },
            scales: {
                x: { grid: { color: chartGridColor }, ticks: { color: chartTextColor } },
                y: { grid: { color: chartGridColor }, ticks: { color: chartTextColor } }
            }
        };

        // Trend Chart
        if (chartData.trend) {
            new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.trend.labels,
                    datasets: [{
                        label: chartData.trend.label,
                        data: chartData.trend.data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: commonOptions
            });
        }
        // Bar Chart
        if (chartData.bar) {
            new Chart(document.getElementById('barChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.bar.labels,
                    datasets: [{
                        label: chartData.bar.label,
                        data: chartData.bar.data,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'],
                        borderRadius: 4
                    }]
                },
                options: commonOptions
            });
        }
        // Scatter Chart
        if (chartData.scatter) {
            new Chart(document.getElementById('scatterChart').getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Normal', data: chartData.scatter.normal, backgroundColor: '#3b82f6', pointRadius: 2 },
                        { label: 'Anomaly', data: chartData.scatter.anomalies, backgroundColor: '#ef4444', pointRadius: 5 }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            title: { display: true, text: chartData.scatter.x_label, color: chartTextColor },
                            grid: { color: chartGridColor },
                            ticks: { color: chartTextColor }
                        },
                        y: {
                            title: { display: true, text: chartData.scatter.y_label, color: chartTextColor },
                            grid: { color: chartGridColor },
                            ticks: { color: chartTextColor }
                        }
                    }
                }
            });
        }
        // Heatmap (Bubble)
        if (chartData.heatmap) {
            const labels = chartData.heatmap.labels;
            const bubbles = chartData.heatmap.data.map(d => {
                const xIdx = labels.indexOf(d.x);
                const yIdx = labels.indexOf(d.y);
                const val = d.v;
                return { x: xIdx, y: yIdx, r: 8, v: val };
            });
            new Chart(document.getElementById('heatmapChart').getContext('2d'), {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Correlation',
                        data: bubbles,
                        backgroundColor: context => {
                            const v = context.raw ? context.raw.v : 0;
                            return v > 0 ? `rgba(37, 99, 235, ${Math.abs(v)})` : `rgba(239, 68, 68, ${Math.abs(v)})`;
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: { ticks: { callback: v => labels[v], stepSize: 1 }, min: -0.5, max: labels.length - 0.5 },
                        y: { ticks: { callback: v => labels[v], stepSize: 1 }, min: -0.5, max: labels.length - 0.5 }
                    }
                }
            });
        }
    }
</script>
{% endif %}
{% endblock %}